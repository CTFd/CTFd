import{_ as M,c as h,o as g,a as u,w as O,v as q,q as A,F as C,i as E,k as S,t as I,f as j,s as D,z as w,u as v,C as d,$ as t,R as y,S as P,A as R,B as N,E as J}from"./main-DvY3K8eO.js";import{c as k,u as T}from"../graphs-D7_mhAOs.js";import{C as x}from"../CommentBox-DAFh8Ri2.js";import"../echarts.common-DqHxtDez.js";const z={name:"UserAddForm",props:{team_id:Number},data:function(){return{searchedName:"",awaitingSearch:!1,emptyResults:!1,userResults:[],selectedResultIdx:0,selectedUsers:[]}},methods:{searchUsers:function(){if(this.selectedResultIdx=0,this.searchedName==""){this.userResults=[];return}d.fetch(`/api/v1/users?view=admin&field=name&q=${this.searchedName}`,{method:"GET",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{e.success&&(this.userResults=e.data.slice(0,10))})},moveCursor:function(e){switch(e){case"up":this.selectedResultIdx&&(this.selectedResultIdx-=1);break;case"down":this.selectedResultIdx<this.userResults.length-1&&(this.selectedResultIdx+=1);break}},selectUser:function(e){e===void 0&&(e=this.selectedResultIdx);let s=this.userResults[e];this.selectedUsers.some(i=>i.id===s.id)===!1&&this.selectedUsers.push(s),this.userResults=[],this.searchedName=""},removeSelectedUser:function(e){this.selectedUsers=this.selectedUsers.filter(s=>s.id!==e)},handleAddUsersRequest:function(){let e=[];return this.selectedUsers.forEach(s=>{let a={user_id:s.id};e.push(d.fetch(`/api/v1/teams/${this.$props.team_id}/members`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(a)}))}),Promise.all(e)},handleRemoveUsersFromTeams:function(){let e=[];return this.selectedUsers.forEach(s=>{let a={user_id:s.id};e.push(d.fetch(`/api/v1/teams/${s.team_id}/members`,{method:"DELETE",body:JSON.stringify(a)}))}),Promise.all(e)},addUsers:function(){let e=[];if(this.selectedUsers.forEach(s=>{s.team_id&&e.push(s.name)}),e.length){let s=w(e.join(", "));v({title:"Confirm Team Removal",body:`The following users are currently in teams:<br><br> ${s} <br><br>Are you sure you want to remove them from their current teams and add them to this one? <br><br>All of their challenge solves, attempts, awards, and unlocked hints will also be deleted!`,success:()=>{this.handleRemoveUsersFromTeams().then(a=>{this.handleAddUsersRequest().then(i=>{window.location.reload()})})}})}else this.handleAddUsersRequest().then(s=>{window.location.reload()})}},watch:{searchedName:function(e){this.awaitingSearch===!1&&setTimeout(()=>{this.searchUsers(),this.awaitingSearch=!1},1e3),this.awaitingSearch=!0}}},F={class:"form-group"},B=u("label",null,"Search Users",-1),L={class:"form-group"},G=["onClick"],V={class:"form-group"},H={key:0,class:"text-center"},K=u("span",{class:"text-muted"}," No users found ",-1),Q=[K],W={class:"list-group"},Y=["onClick"],X={class:"form-group"};function Z(e,s,a,i,l,r){return g(),h("div",null,[u("div",F,[B,O(u("input",{type:"text",class:"form-control",placeholder:"Search for users","onUpdate:modelValue":s[0]||(s[0]=o=>e.searchedName=o),onKeyup:[s[1]||(s[1]=A(o=>r.moveCursor("down"),["down"])),s[2]||(s[2]=A(o=>r.moveCursor("up"),["up"])),s[3]||(s[3]=A(o=>r.selectUser(),["enter"]))]},null,544),[[q,e.searchedName]])]),u("div",L,[(g(!0),h(C,null,E(e.selectedUsers,o=>(g(),h("span",{class:"badge badge-primary mr-1",key:o.id},[S(I(o.name)+" ",1),u("a",{class:"btn-fa",onClick:n=>r.removeSelectedUser(o.id)}," Ã—",8,G)]))),128))]),u("div",V,[e.userResults.length==0&&this.searchedName!=""&&e.awaitingSearch==!1?(g(),h("div",H,Q)):j("",!0),u("ul",W,[(g(!0),h(C,null,E(e.userResults,(o,n)=>(g(),h("li",{class:D({"list-group-item":!0,active:n===e.selectedResultIdx}),key:o.id,onClick:c=>r.selectUser(n)},[S(I(o.name)+" ",1),o.team_id?(g(),h("small",{key:0,class:D({"float-right":!0,"text-white":n===e.selectedResultIdx,"text-muted":n!==e.selectedResultIdx})}," already in a team ",2)):j("",!0)],10,Y))),128))])]),u("div",X,[u("button",{class:"btn btn-success d-inline-block float-right",onClick:s[4]||(s[4]=o=>r.addUsers())}," Add Users ")])])}const ee=M(z,[["render",Z]]);function te(e){e.preventDefault();const s=t("#team-info-create-form").serializeJSON(!0);s.fields=[];for(const a in s)if(a.match(/fields\[\d+\]/)){let i={},l=parseInt(a.slice(7,-1));i.field_id=l,i.value=s[a],s.fields.push(i),delete s[a]}d.fetch("/api/v1/teams",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(s)}).then(function(a){return a.json()}).then(function(a){if(a.success){const i=a.data.id;window.location=d.config.urlRoot+"/admin/teams/"+i}else t("#team-info-create-form > #results").empty(),Object.keys(a.errors).forEach(function(i,l){t("#team-info-create-form > #results").append(y({type:"error",body:a.errors[i]}));const r=t("#team-info-create-form").find("input[name={0}]".format(i)),o=t(r);o.addClass("input-filled-invalid"),o.removeClass("input-filled-valid")})})}function se(e){e.preventDefault();let s=t("#team-info-edit-form").serializeJSON(!0);s.fields=[];for(const a in s)if(a.match(/fields\[\d+\]/)){let i={},l=parseInt(a.slice(7,-1));i.field_id=l,i.value=s[a],s.fields.push(i),delete s[a]}d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(s)}).then(function(a){return a.json()}).then(function(a){a.success?window.location.reload():(t("#team-info-form > #results").empty(),Object.keys(a.errors).forEach(function(i,l){t("#team-info-form > #results").append(y({type:"error",body:a.errors[i]}));const r=t("#team-info-form").find("input[name={0}]".format(i)),o=t(r);o.addClass("input-filled-invalid"),o.removeClass("input-filled-valid")}))})}function ae(e){let a=t("input[data-submission-type=incorrect]:checked").map(function(){return t(this).data("submission-id")}),i=a.length===1?"submission":"submissions";v({title:"Correct Submissions",body:`Are you sure you want to mark ${a.length} ${i} correct?`,success:function(){const l=[];for(var r of a){let o=d.fetch(`/api/v1/submissions/${r}`,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({type:"correct"})});l.push(o)}Promise.all(l).then(o=>{window.location.reload()})}})}function U(e,s){let a,i,l;switch(s){case"solves":a=t("input[data-submission-type=correct]:checked"),i="solve",l="Solves";break;case"fails":a=t("input[data-submission-type=incorrect]:checked"),i="fail",l="Fails";break}let r=a.map(function(){return t(this).data("submission-id")}),o=r.length===1?i:i+"s";v({title:`Delete ${l}`,body:`Are you sure you want to delete ${r.length} ${o}?`,success:function(){const n=[];for(var c of r)n.push(d.api.delete_submission({submissionId:c}));Promise.all(n).then(m=>{window.location.reload()})}})}function ie(e){let s=t("input[data-award-id]:checked").map(function(){return t(this).data("award-id")}),a=s.length===1?"award":"awards";v({title:"Delete Awards",body:`Are you sure you want to delete ${s.length} ${a}?`,success:function(){const i=[];for(var l of s){let r=d.fetch("/api/v1/awards/"+l,{method:"DELETE",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}});i.push(r)}Promise.all(i).then(r=>{window.location.reload()})}})}function ne(e){e.preventDefault();let s=t("input[data-missing-challenge-id]:checked").map(function(){return t(this).data("missing-challenge-id")}),a=s.length===1?"challenge":"challenges";v({title:"Mark Correct",body:`Are you sure you want to mark ${s.length} ${a} correct for ${w(window.TEAM_NAME)}?`,success:function(){J({title:"User Attribution",body:`
        Which user on ${w(window.TEAM_NAME)} solved these challenges?
        <div class="pb-3" id="query-team-member-solve">
        ${t("#team-member-select").html()}
        </div>
        `,button:"Mark Correct",success:function(){const i=t("#query-team-member-solve > select").val(),l=[];for(var r of s){let o={provided:"MARKED AS SOLVED BY ADMIN",user_id:i,team_id:window.TEAM_ID,challenge_id:r,type:"correct"},n=d.fetch("/api/v1/submissions",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(o)});l.push(n)}Promise.all(l).then(o=>{window.location.reload()})}})}})}const $={team:[e=>d.api.get_team_solves({teamId:e}),e=>d.api.get_team_fails({teamId:e}),e=>d.api.get_team_awards({teamId:e})],user:[e=>d.api.get_user_solves({userId:e}),e=>d.api.get_user_fails({userId:e}),e=>d.api.get_user_awards({userId:e})]},oe=(e,s,a,i)=>{let[l,r,o]=$[e];Promise.all([l(i),r(i),o(i)]).then(n=>{k("score_graph","#score-graph",n,e,s,a,i),k("category_breakdown","#categories-pie-graph",n,e,s,a,i),k("solve_percentages","#keys-pie-graph",n,e,s,a,i)})},re=(e,s,a,i)=>{let[l,r,o]=$[e];Promise.all([l(i),r(i),o(i)]).then(n=>{T("score_graph","#score-graph",n,e,s,a,i),T("category_breakdown","#categories-pie-graph",n,e,s,a,i),T("solve_percentages","#keys-pie-graph",n,e,s,a,i)})};t(()=>{t("#team-captain-form").submit(function(n){n.preventDefault();const c=t("#team-captain-form").serializeJSON(!0);d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"PATCH",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(c)}).then(function(m){return m.json()}).then(function(m){m.success?window.location.reload():(t("#team-captain-form > #results").empty(),Object.keys(m.errors).forEach(function(f,_){t("#team-captain-form > #results").append(y({type:"error",body:m.errors[f]}));const p=t("#team-captain-form").find("select[name={0}]".format(f)),b=t(p);b.addClass("input-filled-invalid"),b.removeClass("input-filled-valid")}))})}),t(".edit-team").click(function(n){t("#team-info-edit-modal").modal("toggle")}),t(".invite-team").click(function(n){d.fetch(`/api/v1/teams/${window.TEAM_ID}/members`,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"}}).then(function(c){return c.json()}).then(function(c){if(c.success){let m=c.data.code,f=`${window.location.origin}${d.config.urlRoot}/teams/invite?code=${m}`;t("#team-invite-modal input[name=link]").val(f),t("#team-invite-modal").modal("toggle")}})}),t("#team-invite-link-copy").click(function(n){P(n,"#team-invite-link")}),t(".members-team").click(function(n){t("#team-add-modal").modal("toggle")}),t(".edit-captain").click(function(n){t("#team-captain-modal").modal("toggle")}),t(".award-team").click(function(n){t("#team-award-modal").modal("toggle")}),t(".addresses-team").click(function(n){t("#team-addresses-modal").modal("toggle")}),t("#user-award-form").submit(function(n){n.preventDefault();const c=t("#user-award-form").serializeJSON(!0);if(c.user_id=t("#award-member-input").val(),c.team_id=window.TEAM_ID,t("#user-award-form > #results").empty(),!c.user_id){t("#user-award-form > #results").append(y({type:"error",body:"Please select a team member"}));return}c.user_id=parseInt(c.user_id),d.fetch("/api/v1/awards",{method:"POST",credentials:"same-origin",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(c)}).then(function(m){return m.json()}).then(function(m){m.success?window.location.reload():(t("#user-award-form > #results").empty(),Object.keys(m.errors).forEach(function(f,_){t("#user-award-form > #results").append(y({type:"error",body:m.errors[f]}));const p=t("#user-award-form").find("input[name={0}]".format(f)),b=t(p);b.addClass("input-filled-invalid"),b.removeClass("input-filled-valid")}))})}),t(".delete-member").click(function(n){n.preventDefault();const c=t(this).attr("member-id"),m=t(this).attr("member-name"),f={user_id:c},_=t(this).parent().parent();v({title:"Remove Member",body:"Are you sure you want to remove {0} from {1}? <br><br><strong>All of their challenge solves, attempts, awards, and unlocked hints will also be deleted!</strong>".format("<strong>"+w(m)+"</strong>","<strong>"+w(window.TEAM_NAME)+"</strong>"),success:function(){d.fetch("/api/v1/teams/"+window.TEAM_ID+"/members",{method:"DELETE",body:JSON.stringify(f)}).then(function(p){return p.json()}).then(function(p){p.success&&_.remove()})}})}),t(".delete-team").click(function(n){v({title:"Delete Team",body:"Are you sure you want to delete {0}".format("<strong>"+w(window.TEAM_NAME)+"</strong>"),success:function(){d.fetch("/api/v1/teams/"+window.TEAM_ID,{method:"DELETE"}).then(function(c){return c.json()}).then(function(c){c.success&&(window.location=d.config.urlRoot+"/admin/teams")})}})}),t("#solves-delete-button").click(function(n){U(n,"solves")}),t("#correct-fail-button").click(ae),t("#fails-delete-button").click(function(n){U(n,"fails")}),t("#awards-delete-button").click(function(n){ie()}),t("#missing-solve-button").click(function(n){ne(n)}),t("#team-info-create-form").submit(te),t("#team-info-edit-form").submit(se);let e=document.createElement("div");document.querySelector("#comment-box").appendChild(e),R({render:()=>N(x,{type:"team",id:window.TEAM_ID})}).mount(e);let s=document.createElement("div");document.querySelector("#team-add-modal .modal-body").appendChild(s),R({render:()=>N(ee,{team_id:window.TEAM_ID})}).mount(s);let a,i,l,r;({type:a,id:i,name:l,account_id:r}=window.stats_data);let o;t("#team-statistics-modal").on("shown.bs.modal",function(n){oe(a,i,l,r),o=setInterval(()=>{re(a,i,l,r)},3e5)}),t("#team-statistics-modal").on("hidden.bs.modal",function(n){clearInterval(o)}),t(".statistics-team").click(function(n){t("#team-statistics-modal").modal("toggle")})});
