import{Q as V,R as B,S as D,U as _,W as M,X as N,c as p,Y as l,j as S,b as E,a as n,h as F,l as L,Z as O,t as P,w as z,a0 as Y,o as f,u as q,A as C,C as g,V as G}from"./main-8It0HuHJ.js";const J={key:0,class:"alert alert-warning alert-dismissible mb-3",role:"alert"},Q=n("i",{class:"fas fa-exclamation-triangle me-2"},null,-1),X=n("strong",null,"Email Sending in Progress",-1),Z=n("br",null,null,-1),H=["onSubmit"],I={class:"mb-3"},W=n("label",{for:"body",class:"form-label"},"Email Content",-1),K=["disabled"],ee=["disabled"],te={key:1,class:"mt-3"},se={class:"progress",style:{height:"25px"}},ae=["aria-valuenow","aria-valuemax"],ne={class:"mt-1 text-center"},oe=5e3,ie=100,re=100,h=8,le=V({__name:"EmailAll",setup(v){const a=B({body:"",isProcessing:!1,total:0,sent:0,failed:[]}),{body:i,isProcessing:c,total:u,sent:d,failed:m}=D(a),$=_(()=>u.value>0?d.value/u.value*100:0),A=_(()=>`${d.value} / ${u.value} sent`),b=e=>{if(c.value)return e.preventDefault(),e.returnValue="Emails are currently being sent. Are you sure you want to leave?","Emails are currently being sent. Are you sure you want to leave?"};M(()=>{window.addEventListener("beforeunload",b)}),N(()=>{window.removeEventListener("beforeunload",b)});const y=e=>new Promise(t=>setTimeout(t,e));async function j(e){var o;const t=new URLSearchParams({page:String(e),per_page:String(ie)}),r=await(await g.fetch(`/api/v1/users?${t}`)).json();return{data:r.data??[],pagination:((o=r.meta)==null?void 0:o.pagination)??{}}}async function T(e,t){const s=await g.fetch(`/api/v1/users/${e}/email`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})});if(s.status===429){console.log("Rate limit hit (429), waiting for 1 minute..."),await y(6e4);const r=await g.fetch(`/api/v1/users/${e}/email`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})});try{return(await r.json()).success===!0}catch{return!1}}try{return(await s.json()).success===!0}catch{return!1}}async function k(){if(!i.value)return;const e=i.value.length>200?i.value.substring(0,200)+"...":i.value;q({title:"Confirm Email Send",body:`
      <p>You are about to send the following email to all users:</p>
      <div class="bg-light border-left border-primary border-3" style="padding: 15px; border-width: 3px !important; margin: 10px 0;">
        <pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">${e}</pre>
      </div>
      <p><strong>Are you sure you want to proceed?</strong></p>
    `,success:function(){U()}})}async function U(){a.isProcessing=!0,a.total=0,a.sent=0,a.failed=[];try{let e=1,t=1;for(;e<=t&&e<=re;){const{data:s,pagination:r}=await j(e);if(e===1&&(a.total=r.total??0,t=r.pages??1),!s.length)break;for(let o=0;o<s.length;o+=h){const R=s.slice(o,o+h);for(const w of R)await T(w.id,i.value)?a.sent++:a.failed.push({id:w.id,reason:"Unknown error"});o+h<s.length&&await y(oe)}e++}}catch(e){C({title:"Fatal Error",body:e.message,button:"Close"})}finally{let e="Success",t=`Finished sending emails. ${d.value} / ${u.value} sent.`;m.value.length&&(e="Partial Success",t+=`

Failed attempts (${m.value.length}):`,m.value.forEach(s=>t+=`
- User ID ${s.id}: ${s.reason}`)),C({title:e,body:t,button:"Close"}),a.isProcessing=!1}}return(e,t)=>(f(),p("div",null,[l(c)?(f(),p("div",J,[Q,S("Â  "),X,Z,S(" Please do not close this page or disconnect from the internet while emails are being sent. This process may take several minutes to complete. ")])):E("",!0),n("form",{onSubmit:z(k,["prevent"])},[n("div",I,[W,F(n("textarea",{id:"body","onUpdate:modelValue":t[0]||(t[0]=s=>O(i)?i.value=s:null),disabled:l(c),class:"form-control",rows:"10",required:""},null,8,K),[[L,l(i),void 0,{trim:!0}]])]),n("button",{type:"submit",class:"btn btn-primary",disabled:l(c)},P(l(c)?"Sending...":"Send Emails"),9,ee)],40,H),l(c)?(f(),p("div",te,[n("div",se,[n("div",{class:"progress-bar",role:"progressbar",style:Y({width:$.value+"%"}),"aria-valuenow":l(d),"aria-valuemin":"0","aria-valuemax":l(u)},null,12,ae)]),n("p",ne,P(A.value),1)])):E("",!0)]))}}),x=document.querySelector("#email-all-view");if(x){const v=G.extend(le),a=document.createElement("div");x.appendChild(a),new v().$mount(a)}
