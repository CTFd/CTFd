<div role="tabpanel" class="tab-pane config-section" id="accounts">

	{% set verify_emails = "true" if verify_emails == True else "false" %}
	{% set name_changes = "true" if name_changes == True else "false" %}
	{% set team_creation = "false" if team_creation == False else "true" %}
	{% with form = Forms.config.AccountSettingsForm(verify_emails=verify_emails, name_changes=name_changes, team_disbanding=team_disbanding, team_creation=team_creation) %}
	<form method="POST" autocomplete="off" class="w-100">
		<ul class="nav nav-tabs mb-3">
			<li class="nav-item">
				<a class="nav-link active" href="#user-accounts" aria-controls="user-accounts" role="tab" data-toggle="tab">
					User Accounts
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" href="#team-accounts" aria-controls="team-accounts" role="tab" data-toggle="tab">
					Team Accounts
				</a>
			</li>
		</ul>

		<div class="tab-content">
			<div role="tabpanel" class="tab-pane active" id="user-accounts">
				<div id="user-accounts">
					<div class="form-group">
						{{ form.domain_whitelist.label }}
						{{ form.domain_whitelist(class="form-control", value=domain_whitelist or "") }}
						<small class="form-text text-muted">
							{{ form.domain_whitelist.description }}
						</small>
					</div>

					<div class="form-group">
						{{ form.email_whitelist.label }}
						{{ form.email_whitelist(class="form-control", value=email_whitelist or "", id="email_whitelist_input") }}
						<small class="form-text text-muted">
							{{ form.email_whitelist.description }}
						</small>
						<label for="email_whitelist_csv" class="mt-2">Import from CSV:</label>
						<input type="file" accept=".csv" id="email_whitelist_csv" class="form-control-file">
					</div>

					<div class="form-group">
						{{ form.domain_blacklist.label }}
						{{ form.domain_blacklist(class="form-control", value=domain_blacklist or "") }}
						<small class="form-text text-muted">
							{{ form.domain_blacklist.description }}
						</small>
					</div>

					<div class="form-group">
						{{ form.email_blacklist.label }}
						{{ form.email_blacklist(class="form-control", value=email_blacklist or "", id="email_blacklist_input") }}
						<small class="form-text text-muted">
							{{ form.email_blacklist.description }}
						</small>
						<label for="email_blacklist_csv" class="mt-2">Import from CSV:</label>
						<input type="file" accept=".csv" id="email_blacklist_csv" class="form-control-file">
					</div>
			
					<div class="form-group">
						{{ form.verify_emails.label }}
						{{ form.verify_emails(class="form-control custom-select") }}
						<small class="form-text text-muted">
							{{ form.verify_emails.description }}
						</small>
					</div>
			
					<div class="form-group">
						{{ form.num_users.label }}
						{{ form.num_users(class="form-control", value=num_users) }}
						<small class="form-text text-muted">
							{{ form.num_users.description }}
						</small>
					</div>
			
					<div class="form-group">
						{{ form.incorrect_submissions_per_min.label }}
						{{ form.incorrect_submissions_per_min(class="form-control", value=incorrect_submissions_per_min) }}
						<small class="form-text text-muted">
							{{ form.incorrect_submissions_per_min.description }}
						</small>
					</div>
			
					<div class="form-group">
						{{ form.name_changes.label }}
						{{ form.name_changes(class="form-control custom-select") }}
						<small class="form-text text-muted">
							{{ form.name_changes.description }}
						</small>
					</div>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane" id="team-accounts">
				<div id="team-accounts">
					<div class="form-group">
						{{ form.team_creation.label }}
						{{ form.team_creation(class="form-control", value=team_creation) }}
						<small class="form-text text-muted">
							{{ form.team_creation.description }}
						</small>
					</div>
			
					<div class="form-group">
						{{ form.team_size.label }}
						{{ form.team_size(class="form-control", value=team_size) }}
						<small class="form-text text-muted">
							{{ form.team_size.description }}
						</small>
					</div>
			
					<div class="form-group">
						{{ form.num_teams.label }}
						{{ form.num_teams(class="form-control", value=num_teams) }}
						<small class="form-text text-muted">
							{{ form.num_teams.description }}
						</small>
					</div>

					<div class="form-group">
						{{ form.team_disbanding.label }}
						{{ form.team_disbanding(class="form-control", value=team_disbanding) }}
						<small class="form-text text-muted">
							{{ form.team_disbanding.description }}
						</small>
					</div>
				</div>
			</div>
		</div>

		<button type="button" id="customSubmitBtn" class="btn btn-md btn-primary float-right">Submit</button>
	</form>

	<!-- Conflict Confirmation Modal -->
	<div class="modal fade" id="conflictModal" tabindex="-1" role="dialog" aria-labelledby="conflictModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="conflictModalLabel">Conflict Detected</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					One or more emails or domains are listed in both the whitelist and the blacklist.<br><br>
					<strong>Conflicting entries:</strong>
					<ul id="conflictList" class="mt-2"></ul>
					<p class="mt-3">Are you sure you want to proceed with this configuration?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-primary" id="confirmSubmitBtn">Yes, continue</button>
				</div>
			</div>
		</div>
	</div>
	{% endwith %}
</div>
<script>
document.getElementById('email_whitelist_csv').addEventListener('change', function(e) {
	const file = e.target.files[0];
	if (!file) return;

	const reader = new FileReader();
	reader.onload = function(event) {
		const csvContent = event.target.result;
		document.getElementById('email_whitelist_input').value = csvContent.trim().replace(/\s+/g, '');
	};
	reader.readAsText(file);
});

document.getElementById('email_blacklist_csv').addEventListener('change', function(e) {
	const file = e.target.files[0];
	if (!file) return;

	const reader = new FileReader();
	reader.onload = function(event) {
		const csvContent = event.target.result;
		document.getElementById('email_blacklist_input').value = csvContent.trim().replace(/\s+/g, '');
	};
	reader.readAsText(file);
});

document.addEventListener('DOMContentLoaded', function () {
	const form = document.querySelector('form');
	if (!form) return;

	// When the custom "Save" button is clicked
	document.getElementById('customSubmitBtn').addEventListener('click', function() {
		// Get and sanitize input values (remove spaces, empty strings)
		const emailWhitelist = document.getElementById('email_whitelist_input').value.split(',').map(x => x.trim()).filter(Boolean);
		const emailBlacklist = document.getElementById('email_blacklist_input').value.split(',').map(x => x.trim()).filter(Boolean);

		const domainWhitelist = document.querySelector('[name="domain_whitelist"]').value.split(',').map(x => x.trim()).filter(Boolean);
		const domainBlacklist = document.querySelector('[name="domain_blacklist"]').value.split(',').map(x => x.trim()).filter(Boolean);

		// Check for overlapping/conflicting values
		const emailConflicts = emailWhitelist.filter(email => emailBlacklist.includes(email));
		const domainConflicts = domainWhitelist.filter(domain => domainBlacklist.includes(domain));

		if (emailConflicts.length > 0 || domainConflicts.length > 0) {
			// If there are conflicts, show the modal and list the conflicts
			const conflictList = document.getElementById('conflictList');
			conflictList.innerHTML = '';

			emailConflicts.forEach(email => {
				const li = document.createElement('li');
				li.textContent = `Email: ${email}`;
				conflictList.appendChild(li);
			});

			domainConflicts.forEach(domain => {
				const li = document.createElement('li');
				li.textContent = `Domain: ${domain}`;
				conflictList.appendChild(li);
			});

			// Show the Bootstrap modal
			$('#conflictModal').modal('show');

			// If the user confirms, proceed with form submission
			document.getElementById('confirmSubmitBtn').onclick = function() {
				$('#conflictModal').modal('hide');
				form.requestSubmit(); // Triggers HTML5 form validation before submitting
			};
		} else {
			// No conflicts: submit the form directly
			form.requestSubmit();
		}
	});
});
</script>